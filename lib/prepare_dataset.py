import argparse
from pathlib import Path

import pandas as pd

from data_processor import SentimentAggregator


def load_price_parquet(path: str) -> pd.DataFrame:
    """Load normalized OHLCV parquet produced by klineAcquision.

    Expects index to be timestamp and at least a `close` column.
    """
    df = pd.read_parquet(path)
    if not isinstance(df.index, pd.DatetimeIndex):
        raise ValueError("Price parquet index must be a DatetimeIndex.")
    return df


def build_sentiment_5m(sentiment_csv: str, decay_span: int = 12) -> pd.DataFrame:
    """Aggregate per-news sentiment scores to 5-minute candles with optional decay.

    Returns a DataFrame indexed by timestamp with a single column `sentiment_score`.
    """
    df_sent = SentimentAggregator.normalize_to_candles(
        sentiment_csv=sentiment_csv,
        timeframe="5T",  # 5 minutes
        agg_method="mean",
        decay_span=decay_span,
    )
    return df_sent


def merge_price_and_sentiment(
    price_df: pd.DataFrame,
    sentiment_df: pd.DataFrame,
) -> pd.DataFrame:
    """Left-join price and sentiment on timestamp index and fill missing sentiment with 0."""
    # Align sentiment to price time range
    start_ts = price_df.index.min()
    end_ts = price_df.index.max()
    sentiment_df = sentiment_df.loc[start_ts:end_ts]

    merged = price_df.join(sentiment_df, how="left")
    if "sentiment_score" not in merged.columns:
        merged["sentiment_score"] = 0.0
    else:
        merged["sentiment_score"] = merged["sentiment_score"].fillna(0.0)
    return merged


def prepare_dataset(
    price_parquet: str,
    sentiment_csv: str,
    out_path: str,
    decay_span: int = 12,
) -> None:
    """High-level helper to build a merged 5m price+sentiment dataset.

    - price_parquet: output from klineAcquision (e.g. kline_BTCUSDT_5m_last3d_YYYY-MM-DD.parquet)
    - sentiment_csv: output from CryptoSentimentRunner.run_csv (with timestamp, score columns)
    - out_path: where to save the merged parquet
    """
    price_df = load_price_parquet(price_parquet)
    sent_df = build_sentiment_5m(sentiment_csv, decay_span=decay_span)
    merged_df = merge_price_and_sentiment(price_df, sent_df)

    out_path = Path(out_path)
    out_path.parent.mkdir(parents=True, exist_ok=True)
    merged_df.to_parquet(out_path)

    print("\n=== 合并后数据集预览（最后 5 行）===")
    print(merged_df.tail())
    print("\n列: ", list(merged_df.columns))
    print(f"\n已保存合并后的数据集到: {out_path}")


def main() -> None:
    parser = argparse.ArgumentParser(
        description="Prepare merged 5m price + sentiment dataset for backtesting.",
    )
    parser.add_argument(
        "--price-parquet",
        required=True,
        help="Path to price parquet generated by klineAcquision.",
    )
    parser.add_argument(
        "--sentiment-csv",
        required=True,
        help="Path to sentiment results CSV from CryptoSentimentRunner.run_csv.",
    )
    parser.add_argument(
        "--out",
        required=True,
        help="Output parquet path for merged dataset.",
    )
    parser.add_argument(
        "--decay-span",
        type=int,
        default=12,
        help="EWMA decay span for sentiment (in 5-min bars).",
    )

    args = parser.parse_args()
    prepare_dataset(
        price_parquet=args.price_parquet,
        sentiment_csv=args.sentiment_csv,
        out_path=args.out,
        decay_span=args.decay_span,
    )


if __name__ == "__main__":
    main()
